# System Configuration

The following config sources are all loaded if available. The leading config overrides the latter:

  1. The config file specified in the environment variable `CONFIG_FILE`
  2. The config file `./total-tolles-ferleihsystem.conf`
  3. The config file `/etc/total-tolles-ferleihsystem.conf`
  4. The default values

## Format

A configuration file is a python file which is run when the config is loaded.
This means the format to set a setting is:
```python
key = value
```
The value can be `True` and `False` for boolean values, `0` or `0xff` for integer values and `'/tmp/test'` for string values.

> CAUTION! Be aware that you can potentially run any code inside a config file.
> You shall not allow access to the config from untrusty sources or sources from the internet in order to prevent a remote code execution attack.

For further information on the syntax please read any python tutorial or the [official python specification](https://docs.python.org/3/).

  - [LearnPython.org](https://www.learnpython.org/)
  - [LearnXInYMinutes](https://learnxinyminutes.com/docs/python3/)


## Environment Variables

The api needs two environment variables to function properly, those are `FLASK_APP` and `MODE`.
The `FLASK_APP` variable must be set to `total_tolles_ferleihsystem` as this is required by flask to find and run our api.
The `mode` variable can be set to the following values:

| value        | description |
|:-------------|:------------|
| `PRODUCTION` | This puts the api in production mode, this removes all debug api endpoints and loads different default settings. |
| `DEBUG`      | This puts the api in debug mode, activating more verbose error handling and enables all debug api endpoints. |
| `TEST`       | Currently unused! Will be used for automated testing. |

Additionally the environment variable `FLASK_DEBUG=1` can be provided.
This makes flask reload the api if the source files change, but this is optional.


### Configuration over Environment Variables

Additionally some config options can be set via environment variables.
Of course those settings override every other config file.
This is only possible with the following config options:

  - `JWT_SECRET_KEY` [Details]()
  - `SQLALCHEMY_DATABASE_URI` [Details]()
  - `CELERY_BROKER_URL` [Details]()
  - `CELERY_RESULT_BACKEND` [Details]()



## Configuration Options

### `BCRYPT_HANDLE_LONG_PASSWORDS`

  - Default: `True`
  - Should NOT be changed


### `DATA_DIRECTORY`

This path must point to a folder.
It is used to store all the files which are uploaded to the system and are available for download.

  - Default: `'/tmp'`


### `DB_UNIQUE_CONSTRAIN_FAIL`

This string is used to match the error string generated by the sql engine from sqlalchemy if a unique constraint has failed.
This is done in order to return the correct error code and error message to the user.
Depending on the engine and driver this needs to be adapted.

  - Default: `UNIQUE constraint failed`


### `JWT_ACCESS_TOKEN_EXPIRES`

This setting sets if the jwt access token and refresh token do expire.

  - Default:
    - Production: `True`
    - Debug: `False`


### `JWT_CLAIMS_IN_REFRESH_TOKEN`

  - Default: `True`
  - Should NOT be changed


### `JWT_SECRET_KEY`

This sets the jwt secret key.
The secret key is used to create the jwt keys thus keeping logins active through restarts or multiple api instances with the same secret key.
If it is changed all previous logins are automatically invalidated.
This should be a secure random string.

  - Default:
    - Production: `''.join(hex(randint(0, 255))[2:] for i in range(16))`
    - Debug: `'debug'`
  - Should always be changed to a non changing value to keep logins active.


### `RESTPLUS_VALIDATE`

  - Default: `True`
  - Should NOT be changed


### `SQLALCHEMY_DATABASE_URI`

This configuration option sets the database which is used to store the data created and used by the system.
Although sqlalchemy might support more options for the database uri then presented below, we only test and develop for the following values:

  - `'sqlite://:memory:'`

    This is the simplest and most unreliable solution.
    This creates a in-memory sqlite database to use, thus it is deleted when the api process terminates.

  - `'sqlite:///<path>'`

    This creates a sqlite database at the specified path.
    This file can be anywhere but be aware of file ownership and and access rights.
    The path should always be absolut.

  - `'mysql+<driver>://<user>:<password>@<host>:<port>/<database>'`

    This allows the api to connect to a mysql or mariadb server.
    The driver typically is either `mysqlconnector` or `cymysql`.
    A complete list cam be found in the [offical documentation](https://docs.sqlalchemy.org/en/13/dialects/mysql.html#dialect-mysql).
    You should make sure that strings are always treated as utf8mb4, otherwise smilies, cjk-characters and other unicode characters may break the api.
    Of course you need to replace `<driver>`, `<user>`, `<password>`, `<host>`, `<port>` and `<database>` with the appropriate values from your database server.

More detailed information about this or other database option can be found on the [official documentation](https://flask-sqlalchemy.palletsprojects.com/en/2.x/config/#connection-uri-format)
Keep in mind that right now you need to setup the database explicitly with `flask db upgrade`.
This makes using an in-memory sqlite db practically impossible to use, since on termination of the db creation command the db is destructed again.

  - Default:
    - Production: `'sqlite://:memory:'`
    - Debug: `'sqlite:////tmp/test.db'`
  - Must be changed in production mode


### `SQLALCHEMY_TRACK_MODIFICATIONS`

If set to True, Flask-SQLAlchemy will track modifications of objects and emit signals.
The library default is None, which enables tracking but issues a warning that it will be disabled by default in the future.
This requires extra memory and should be disabled if not needed.

  - Default: `False`
  - Should NOT be changed


### `TMP_DIRECTORY`

This path must point to a folder.
It is used to store files temporarily during file upload and zip file creation.

  - Default: `'/tmp'`


### `WEBPACK_MANIFEST_PATH`

Pointer to the manifest of webpack

  - Default: `'./build/manifest.json'`
